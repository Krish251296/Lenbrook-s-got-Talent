<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Lenbrook's Got Talent • Judge Panel</title>

  <style>
    /* global bg + white bar fix */
    html, body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: radial-gradient(circle at 50% 20%, #2e3a60 0%, #0f1424 70%);
      background-color: #0f1424;
      color: #fff;
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif;
    }

    body {
      display: flex;
      flex-direction: column;
      padding: 2rem 1rem 4rem;
      box-sizing: border-box;
      position: relative;
    }

    main {
      position: relative;
      z-index: 2;
      width: 100%;
      max-width: 1300px;
      margin: 0 auto;
    }

    /* snow */
    .snow,
    .snow::before,
    .snow::after {
      content: "";
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      background-repeat: repeat;
      background-size: 3px 3px;
      image-rendering: pixelated;
      z-index: 0;
    }
    .snow {
      background-image: radial-gradient(rgba(255,255,255,0.9) 1.2px, transparent 1.2px);
      animation: snowMoveA 6s linear infinite;
      opacity: 0.6;
    }
    .snow::before {
      background-image: radial-gradient(rgba(255,255,255,0.6) 1px, transparent 1px);
      animation: snowMoveB 10s linear infinite;
      opacity: 0.4;
    }
    .snow::after {
      background-image: radial-gradient(rgba(255,255,255,0.3) 0.8px, transparent 0.8px);
      animation: snowMoveC 14s linear infinite;
      opacity: 0.25;
    }
    @keyframes snowMoveA {
      0%   { transform: translateY(-60px) translateX(0px); }
      100% { transform: translateY(60px)  translateX(20px); }
    }
    @keyframes snowMoveB {
      0%   { transform: translateY(-80px) translateX(0px); }
      100% { transform: translateY(80px)  translateX(-20px); }
    }
    @keyframes snowMoveC {
      0%   { transform: translateY(-100px) translateX(0px); }
      100% { transform: translateY(100px)  translateX(10px); }
    }

    header.page-head {
      position: relative;
      z-index: 2;
      text-align: center;
      margin-bottom: 2rem;
    }
    header.page-head img.logo {
      width: 180px;
      max-width: 60vw;
      height: auto;
      filter: drop-shadow(0 20px 30px rgba(0,0,0,0.6));
    }
    header.page-head h1 {
      color: #fff;
      font-size: 1.3rem;
      font-weight: 600;
      margin: 1rem 0 0.5rem;
      text-shadow: 0 2px 4px rgba(0,0,0,.8);
    }
    header.page-head p.sub {
      margin: 0;
      color: rgba(255,255,255,0.7);
      font-size: .9rem;
      line-height: 1.4;
    }

    /* reviewer login / name gate */
    .access-block {
      max-width: 600px;
      margin: 0 auto 1.5rem;
      background: rgba(0,0,0,0.4);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      box-shadow: 0 40px 80px rgba(0,0,0,.8),0 0 120px rgba(88,130,255,.2) inset;
      color: #fff;
    }
    .access-block h2 {
      margin: 0 0 .75rem;
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
      text-align: center;
    }
    .access-inner {
      display: flex;
      flex-direction: column;
      gap: .75rem;
      align-items: center;
    }
    .access-inner input {
      background: rgba(0,0,0,.4);
      border: 1px solid rgba(255,255,255,.18);
      border-radius: 8px;
      padding: .8rem .8rem;
      min-width: 220px;
      color:#fff;
      font-size:.9rem;
    }
    .access-inner button {
      background: linear-gradient(90deg, rgba(88,130,255,1) 0%, rgba(164,120,255,1) 100%);
      color:#fff;
      font-size:.9rem;
      font-weight:600;
      border:0;
      border-radius:8px;
      padding:.8rem 1rem;
      cursor:pointer;
      box-shadow:0 30px 60px rgba(0,0,0,.9),0 8px 24px rgba(88,130,255,.4),0 0 60px rgba(164,120,255,.6);
    }

    /* table card */
    .table-shell {
      background: radial-gradient(circle at 20% 20%, rgba(60,72,110,.6) 0%, rgba(20,24,40,.6) 70%);
      backdrop-filter: blur(16px) saturate(140%);
      -webkit-backdrop-filter: blur(16px) saturate(140%);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 18px;
      padding: 1rem;
      box-shadow:0 60px 120px rgba(0,0,0,.85),0 8px 24px rgba(0,0,0,.6),0 0 120px rgba(88,130,255,.18) inset;
      overflow-x:auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      min-width: 900px;
      color:#fff;
      font-size:.85rem;
    }
    thead th {
      background: rgba(0,0,0,.4);
      color:#fff;
      font-weight:600;
      text-align:center;
      padding:.75rem .5rem;
      border-bottom:1px solid rgba(255,255,255,.15);
      position:sticky;
      top:0;
      z-index:1;
      white-space:nowrap;
    }
    tbody td {
      text-align:center;
      border-bottom:1px solid rgba(255,255,255,.07);
      padding:.75rem .5rem;
      vertical-align:middle;
    }
    tbody tr:hover {
      background:rgba(255,255,255,.05);
    }
    video {
      width:180px;
      max-height:120px;
      border-radius:8px;
      border:1px solid rgba(255,255,255,.2);
      box-shadow:0 20px 40px rgba(0,0,0,.8);
    }
    input[type="number"] {
      width:60px;
      background:rgba(0,0,0,.4);
      border:1px solid rgba(255,255,255,.18);
      border-radius:8px;
      color:#fff;
      padding:.5rem .5rem;
      font-size:.8rem;
      text-align:center;
    }
    button.save-btn {
      background: linear-gradient(90deg, rgba(88,130,255,1) 0%, rgba(164,120,255,1) 100%);
      color:#fff;
      border:0;
      border-radius:8px;
      padding:.6rem .8rem;
      font-size:.8rem;
      font-weight:600;
      cursor:pointer;
      box-shadow:0 20px 40px rgba(0,0,0,.9),0 8px 24px rgba(88,130,255,.4),0 0 40px rgba(164,120,255,.6);
    }

    .status-line {
      margin:1rem 0 0;
      text-align:center;
      color:rgba(255,255,255,.7);
      font-size:.8rem;
      font-weight:500;
      min-height:1.2em;
    }
  </style>
</head>
<body>
  <div class="snow"></div>

  <header class="page-head">
    <img class="logo" src="logo.png" alt="Lenbrook's Got Talent Logo"/>
    <h1>Judge Panel</h1>
    <p class="sub">Score each act 1–10 in Technical Skill, Creativity, and Entertainment.</p>
  </header>

  <main>
    <!-- reviewer access (name entry only now) -->
    <section class="access-block" id="reviewerSection">
      <h2>Who are you?</h2>
      <div class="access-inner">
        <input id="reviewerName" type="text" placeholder="Your name (for scoring)" />
        <button id="startReviewBtn">Start Reviewing</button>
      </div>
    </section>

    <!-- table -->
    <section class="table-shell" id="tableSection" style="display:none;">
      <div class="status-line" id="status">Loading submissions...</div>

      <table id="submissionsTable">
        <thead>
          <tr>
            <th>Team / Participant</th>
            <th>Collaboration / Departments</th>
            <th>Description</th>
            <th>Video</th>
            <th>Technical Skill</th>
            <th>Creativity</th>
            <th>Entertainment</th>
            <th>Total (You)</th>
            <th>Average (All Reviewers)</th>
            <th>Save Rating</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs,
      doc,
      getDoc,
      updateDoc
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Firebase config (keep same as before for this project)
    const firebaseConfig = {
      apiKey: "AIzaSyCzXbIghLheIWJHEgCCI_oOe5finmUIe1U",
      authDomain: "lenbrook-s-got-talent.firebaseapp.com",
      projectId: "lenbrook-s-got-talent",
      storageBucket: "lenbrook-s-got-talent.firebasestorage.app",
      messagingSenderId: "327419181483",
      appId: "1:327419181483:web:c78bde1ba35d3bf037faee"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const reviewerSection = document.getElementById("reviewerSection");
    const tableSection = document.getElementById("tableSection");
    const startReviewBtn = document.getElementById("startReviewBtn");
    const reviewerNameInput = document.getElementById("reviewerName");

    const tableBody = document.querySelector("#submissionsTable tbody");
    const statusEl = document.getElementById("status");

    let currentReviewer = null;

    startReviewBtn.addEventListener("click", () => {
      const name = reviewerNameInput.value.trim();
      if (!name) {
        alert("Please enter your name before reviewing.");
        return;
      }
      currentReviewer = name;
      reviewerSection.style.display = "none";
      tableSection.style.display = "block";
      statusEl.textContent = "Loading submissions...";
      loadSubmissions();
    });

    async function loadSubmissions() {
      const snapshot = await getDocs(collection(db, "submissions"));
      tableBody.innerHTML = "";

      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const id = docSnap.id;

        // pull this reviewer's previous scores if any
        const userRatings = data.ratings?.[currentReviewer] || {};
        const totalForUser = userRatings.total || 0;
        const avg = data.averageScore ? data.averageScore.toFixed(1) : "-";

        const row = document.createElement("tr");
        row.innerHTML = `
          <td>${data.name || ""}</td>
          <td>${data.department || ""}</td>
          <td>${data.description || ""}</td>
          <td><video src="${data.videoURL}" controls></video></td>
          <td><input type="number" id="tech-${id}" min="1" max="10" value="${userRatings.technical || ""}"></td>
          <td><input type="number" id="creative-${id}" min="1" max="10" value="${userRatings.creativity || ""}"></td>
          <td><input type="number" id="ent-${id}" min="1" max="10" value="${userRatings.entertainment || ""}"></td>
          <td id="total-${id}">${totalForUser}</td>
          <td id="avg-${id}">${avg}</td>
          <td><button class="save-btn" onclick="saveRating('${id}')">Save 💾</button></td>
        `;
        tableBody.appendChild(row);
      });

      statusEl.textContent = "✅ Loaded submissions.";
    }

    // expose saveRating globally
    window.saveRating = async (id) => {
      if (!currentReviewer) {
        alert("Please enter your name first.");
        return;
      }

      const tech = parseInt(document.getElementById(`tech-${id}`).value || 0);
      const creative = parseInt(document.getElementById(`creative-${id}`).value || 0);
      const ent = parseInt(document.getElementById(`ent-${id}`).value || 0);
      const total = tech + creative + ent;

      const ref = doc(db, "submissions", id);
      const snap = await getDoc(ref);
      const existing = snap.data() || {};

      const ratings = existing.ratings || {};
      ratings[currentReviewer] = {
        technical: tech,
        creativity: creative,
        entertainment: ent,
        total
      };

      // recompute average of totals
      const allTotals = Object.values(ratings).map(r => r.total);
      const sumTotals = allTotals.reduce((a,b)=>a+b,0);
      const avg = sumTotals / allTotals.length;

      await updateDoc(ref, {
        ratings,
        averageScore: avg
      });

      document.getElementById(`total-${id}`).textContent = total;
      document.getElementById(`avg-${id}`).textContent = avg.toFixed(1);

      alert(`✅ Rating saved for ${currentReviewer}!`);
    };
  </script>
</body>
</html>
