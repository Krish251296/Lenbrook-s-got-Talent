<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lenbrook‚Äôs Got Talent ‚Äì Finals Results</title>

  <style>
    :root{
      --bg1:#050716;
      --bg2:#111827;
      --bg3:#1f2937;
      --glass:rgba(15,23,42,0.88);
      --glass-soft:rgba(15,23,42,0.7);
      --border:rgba(148,163,184,.55);
      --text:#e5e7eb;
      --muted:#9ca3af;
      --accent:#fbbf24;
      --accent-soft:#fed7aa;
      --accent2:#38bdf8;
      --danger:#fb7185;
      --success:#4ade80;
      --radius-xl:22px;
      --radius-lg:16px;
    }

    *{box-sizing:border-box;margin:0;padding:0;}

    @keyframes gradientShift{
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    @keyframes snow-fall{
      0%{transform:translateY(-10vh) translateX(0);opacity:0}
      10%{opacity:1}
      100%{transform:translateY(110vh) translateX(25px);opacity:0}
    }
    @keyframes fadeInUp{
      0%{opacity:0;transform:translateY(18px)}
      100%{opacity:1;transform:translateY(0)}
    }
    @keyframes floatSoft{
      0%{transform:translateY(0)}
      50%{transform:translateY(-5px)}
      100%{transform:translateY(0)}
    }

    body{
      min-height:100dvh;
      font-family:-apple-system,BlinkMacSystemFont,"Inter",system-ui,Roboto,"Helvetica Neue",Arial,sans-serif;
      color:var(--text);
      background:
        radial-gradient(circle at 0 0,rgba(56,189,248,.2),transparent 60%),
        radial-gradient(circle at 100% 0,rgba(244,114,182,.18),transparent 55%),
        linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3));
      background-size:160% 160%;
      animation:gradientShift 26s ease infinite;
      overflow-x:hidden;
      position:relative;
    }

    .snow-wrap{
      position:fixed;
      inset:0;
      pointer-events:none;
      overflow:hidden;
      z-index:4;
    }
    .flake{
      position:absolute;
      top:-10vh;
      color:#fff;
      text-shadow:0 0 10px rgba(255,255,255,.9);
      opacity:.95;
      animation:snow-fall linear infinite;
    }

    .page{
      position:relative;
      z-index:10;
      max-width:1200px;
      margin:0 auto;
      padding:clamp(16px,2vw,28px);
      padding-bottom:40px;
    }

    .top-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:16px;
      margin-bottom:18px;
    }

    .logo-wrap{
      display:flex;
      align-items:center;
      gap:16px;
    }
    .logo{
      width:clamp(160px,22vw,230px);
      height:auto;
      display:block;
      filter:drop-shadow(0 0 18px rgba(129,140,248,.7));
      animation:floatSoft 7s ease-in-out infinite;
    }
    .title-block{
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .title{
      font-size:1.4rem;
      font-weight:700;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .subtitle{
      font-size:.9rem;
      color:var(--muted);
      max-width:480px;
    }

    .pill-tag{
      background:rgba(15,23,42,.9);
      border:1px solid rgba(148,163,184,.6);
      border-radius:999px;
      padding:.4rem .9rem;
      font-size:.8rem;
      display:inline-flex;
      align-items:center;
      gap:.4rem;
      box-shadow:0 18px 40px rgba(0,0,0,.7);
    }
    .pill-dot{
      width:8px;height:8px;border-radius:999px;
      background:radial-gradient(circle,var(--accent) 0%,#b45309 70%);
      box-shadow:0 0 10px rgba(248,250,252,.9);
    }

    /* Summary row */
    .summary-row{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(190px,1fr));
      gap:14px;
      margin-bottom:18px;
      animation:fadeInUp .55s ease both;
    }
    .summary-card{
      background:var(--glass);
      border:1px solid var(--border);
      border-radius:var(--radius-xl);
      padding:.95rem 1rem;
      box-shadow:0 22px 80px rgba(0,0,0,.85);
      display:flex;
      flex-direction:column;
      gap:4px;
      position:relative;
      overflow:hidden;
    }
    .summary-card::before{
      content:"";
      position:absolute;
      inset:-40%;
      background:radial-gradient(circle at 0 0,rgba(148,163,184,.3),transparent 55%);
      opacity:.5;
      mix-blend-mode:soft-light;
      pointer-events:none;
    }
    .summary-label{
      font-size:.75rem;
      text-transform:uppercase;
      letter-spacing:.08em;
      color:var(--muted);
    }
    .summary-value{
      font-size:1.3rem;
      font-weight:800;
    }
    .summary-sub{
      font-size:.8rem;
      color:var(--muted);
    }
    .summary-pill{
      align-self:flex-start;
      margin-top:.15rem;
      border-radius:999px;
      padding:.15rem .55rem;
      font-size:.72rem;
      border:1px solid rgba(148,163,184,.7);
      background:rgba(15,23,42,.9);
    }

    /* Trophy badge */
    .trophy-pill{
      display:inline-flex;
      align-items:center;
      gap:.35rem;
      font-size:.78rem;
      border-radius:999px;
      padding:.3rem .7rem;
      background:radial-gradient(circle at 30% 0,var(--accent),#b45309);
      color:#111827;
      font-weight:600;
      box-shadow:0 0 16px rgba(251,191,36,.7);
    }

    /* Legend row */
    .legend-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      font-size:.78rem;
      color:var(--muted);
      margin-bottom:12px;
    }
    .legend-left{
      display:flex;
      align-items:center;
      gap:.5rem;
      flex-wrap:wrap;
    }
    .legend-tag{
      border-radius:999px;
      padding:.2rem .6rem;
      border:1px solid rgba(148,163,184,.6);
      background:rgba(15,23,42,.9);
    }
    .updated-text{
      font-size:.78rem;
      color:var(--muted);
      text-align:right;
    }

    /* Results panel */
    .panel{
      background:var(--glass-soft);
      border-radius:24px;
      border:1px solid rgba(148,163,184,.65);
      padding:1rem 1.1rem 1.3rem;
      box-shadow:0 32px 100px rgba(0,0,0,.9);
      backdrop-filter:blur(18px) saturate(150%);
      -webkit-backdrop-filter:blur(18px) saturate(150%);
      animation:fadeInUp .55s ease .05s both;
    }
    .panel-header{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:8px;
      margin-bottom:.7rem;
    }
    .panel-title{
      font-size:1rem;
      font-weight:600;
      letter-spacing:.04em;
      text-transform:uppercase;
    }
    .panel-hint{
      font-size:.78rem;
      color:var(--muted);
    }

    .scroll-wrap{
      overflow:auto;
      border-radius:18px;
      border:1px solid rgba(148,163,184,.55);
      background:
        radial-gradient(circle at 0 0,rgba(148,163,184,.12),transparent 60%),
        radial-gradient(circle at 100% 0,rgba(96,165,250,.12),transparent 55%),
        rgba(15,23,42,.97);
      max-height:70vh;
    }

    table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      min-width:700px;
      font-size:.9rem;
    }
    thead{
      position:sticky;
      top:0;
      z-index:1;
      background:linear-gradient(to bottom,rgba(15,23,42,0.98),rgba(15,23,42,0.93));
      box-shadow:0 1px 0 rgba(148,163,184,.4);
    }
    thead th{
      text-align:left;
      padding:.6rem .9rem;
      font-weight:600;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.06em;
      font-size:.72rem;
      border-bottom:1px solid rgba(148,163,184,.5);
    }
    thead th:first-child{border-top-left-radius:18px;}
    thead th:last-child{border-top-right-radius:18px;}

    tbody tr{
      transition:background .16s ease, transform .14s ease, box-shadow .14s ease, opacity .18s ease;
      opacity:0;
      transform:translateY(12px);
    }
    tbody tr.show{
      opacity:1;
      transform:translateY(0);
    }
    tbody tr:nth-child(even){
      background:rgba(15,23,42,.84);
    }
    tbody tr:nth-child(odd){
      background:rgba(15,23,42,.92);
    }
    tbody tr:hover{
      background:radial-gradient(circle at 0 0,rgba(248,250,252,.08),transparent 60%),
                 rgba(15,23,42,.98);
      transform:translateY(-1px);
      box-shadow:0 12px 28px rgba(15,23,42,.95);
    }
    tbody td{
      padding:.7rem .9rem;
      border-bottom:1px solid rgba(31,41,55,.85);
      vertical-align:middle;
    }
    tbody tr:last-child td{
      border-bottom:none;
    }

    .rank-badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      min-width:26px;
      padding:.18rem .55rem;
      border-radius:999px;
      font-size:.78rem;
      font-weight:700;
      background:rgba(15,23,42,.95);
      border:1px solid rgba(148,163,184,.7);
    }
    .rank-1{
      background:radial-gradient(circle at 30% 0,var(--accent),#b45309);
      color:#111827;
      border:none;
      box-shadow:0 0 18px rgba(251,191,36,.8);
    }
    .rank-2{
      background:radial-gradient(circle at 30% 0,#e5e7eb,#9ca3af);
      color:#111827;
      border:none;
    }
    .rank-3{
      background:radial-gradient(circle at 30% 0,#fed7aa,#c05621);
      color:#111827;
      border:none;
    }

    .perf-name{
      font-weight:600;
      font-size:.95rem;
    }
    .perf-meta{
      font-size:.78rem;
      color:var(--muted);
    }

    .points-pill{
      display:inline-flex;
      padding:.18rem .6rem;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.7);
      font-size:.78rem;
      align-items:center;
      gap:.25rem;
      background:rgba(15,23,42,.96);
    }
    .points-pill strong{
      font-size:.9rem;
    }

    .bar-wrap{
      width:130px;
      height:6px;
      border-radius:999px;
      background:rgba(30,64,175,.7);
      overflow:hidden;
      margin-top:.22rem;
    }
    .bar-fill{
      height:100%;
      border-radius:999px;
      background:linear-gradient(to right,var(--accent2),var(--accent));
      width:0;
      transition:width .6s ease-out;
    }

    .no-data{
      padding:1.2rem;
      text-align:center;
      color:var(--muted);
      font-size:.9rem;
    }

    @media(max-width:720px){
      .top-bar{
        flex-direction:column;
        align-items:flex-start;
      }
      .logo{
        width:170px;
      }
      .panel{
        padding:.95rem;
      }
    }
  </style>
</head>
<body>
  <div class="snow-wrap" id="snowLayer" aria-hidden="true"></div>

  <div class="page">
    <header class="top-bar">
      <div class="logo-wrap">
        <img src="logo.png" alt="Lenbrook's Got Talent" class="logo" />
        <div class="title-block">
          <div class="title">Finals Live Results</div>
          <div class="subtitle">
            Live audience ranking from all ballots submitted tonight.
          </div>
        </div>
      </div>
      <div>
        <div class="pill-tag" style="margin-bottom:6px;">
          <span class="pill-dot"></span>
          <span id="statusText">Loading ballots‚Ä¶</span>
        </div>
        <div class="updated-text" id="updatedText">Last updated ‚Äì</div>
      </div>
    </header>

    <section class="summary-row">
      <div class="summary-card">
        <div class="summary-label">Total Ballots</div>
        <div class="summary-value" id="summaryBallots">‚Äì</div>
        <div class="summary-sub">Valid audience submissions</div>
        <div class="summary-pill">Cumulative, not per act</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Performances</div>
        <div class="summary-value" id="summaryPerformances">‚Äì</div>
        <div class="summary-sub">Finalists on stage</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Top-ranked Act</div>
        <div class="summary-value" id="summaryTopAct">‚Äì</div>
        <div class="summary-sub" id="summaryTopDetails">Based on average rank (lower is better)</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">Audience Favourite</div>
        <div class="trophy-pill">
          üèÜ <span id="summaryTrophy">Waiting for votes‚Ä¶</span>
        </div>
        <div class="summary-sub">Updates as new ballots arrive</div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">Ranking Table</div>
        <div class="panel-hint">
          Average rank is based on positions 1‚Äì5 from every ballot. Lower average rank wins.
        </div>
      </div>

      <div class="legend-row">
        <div class="legend-left">
          <span class="legend-tag">#1 = audience favourite</span>
          <span class="legend-tag">Bars show relative points</span>
        </div>
      </div>

      <div class="scroll-wrap">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Performance</th>
              <th>Avg Rank</th>
              <th>Total Points</th>
              <th>Ballots</th>
            </tr>
          </thead>
          <tbody id="resultsBody">
            <tr>
              <td colspan="5" class="no-data">Loading results‚Ä¶</td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  </div>

  <script type="module">
    /* ‚ùÑ Snow */
    const snowLayer = document.getElementById('snowLayer');
    function flake(){
      if(!snowLayer) return;
      if(snowLayer.childElementCount>220) return;
      const el = document.createElement('div');
      el.className = 'flake';
      el.textContent = '‚Ä¢';
      el.style.fontSize = ((Math.random()*0.7+0.55)*12)+'px';
      el.style.left = (Math.random()*100)+'vw';
      el.style.animationDuration = (Math.random()*4+4)+'s';
      snowLayer.appendChild(el);
      setTimeout(()=>el.remove(),8000);
    }
    setInterval(flake,75);

    const resultsBody = document.getElementById("resultsBody");
    const summaryBallots = document.getElementById("summaryBallots");
    const summaryPerformances = document.getElementById("summaryPerformances");
    const summaryTopAct = document.getElementById("summaryTopAct");
    const summaryTopDetails = document.getElementById("summaryTopDetails");
    const summaryTrophy = document.getElementById("summaryTrophy");
    const statusText = document.getElementById("statusText");
    const updatedText = document.getElementById("updatedText");

    function setUpdatedNow(){
      const d = new Date();
      updatedText.textContent =
        "Last updated " +
        d.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
    }

    /**
     * Call this once you have an array like:
     * [
     *   { name: "Act Name", avgRank: 2.3, totalPoints: 412, ballots: 160, extra?: "meta" },
     *   ...
     * ]
     */
    function renderResults(results){
      if(!results || !results.length){
        resultsBody.innerHTML =
          '<tr><td colspan="5" class="no-data">No votes recorded yet.</td></tr>';
        statusText.textContent = "No ballots yet";
        summaryBallots.textContent = "0";
        summaryPerformances.textContent = "0";
        summaryTopAct.textContent = "‚Äì";
        summaryTopDetails.textContent = "Waiting for votes‚Ä¶";
        summaryTrophy.textContent = "No leader yet";
        return;
      }

      // Sort by avgRank ascending (best first)
      results.sort((a,b) => (a.avgRank ?? 999) - (b.avgRank ?? 999));

      const totalBallots = results.reduce((max, r) => Math.max(max, r.ballots || 0), 0);
      const maxPoints = results.reduce((max, r) => Math.max(max, r.totalPoints || 0), 0);

      resultsBody.innerHTML = results.map((r, idx) => {
        const rank = idx + 1;
        const rankClass =
          rank === 1 ? "rank-badge rank-1" :
          rank === 2 ? "rank-badge rank-2" :
          rank === 3 ? "rank-badge rank-3" :
                       "rank-badge";

        const barPercent = maxPoints ? Math.round((r.totalPoints||0)/maxPoints*100) : 0;

        return `
          <tr>
            <td>
              <span class="${rankClass}">#${rank}</span>
            </td>
            <td>
              <div class="perf-name">${r.name || "Untitled"}</div>
              ${r.extra ? `<div class="perf-meta">${r.extra}</div>` : ""}
            </td>
            <td>
              <div class="points-pill">
                <span>Avg rank</span>
                <strong>${r.avgRank ? r.avgRank.toFixed(2) : "‚Äì"}</strong>
              </div>
            </td>
            <td>
              <div class="points-pill">
                <span>Points</span>
                <strong>${r.totalPoints ?? "‚Äì"}</strong>
              </div>
              <div class="bar-wrap">
                <div class="bar-fill" style="width:${barPercent}%;"></div>
              </div>
            </td>
            <td>
              <span class="perf-meta">${r.ballots || 0} ballots</span>
            </td>
          </tr>
        `;
      }).join("");

      // Animate rows on first paint
      Array.from(resultsBody.querySelectorAll("tr")).forEach((row, idx) => {
        setTimeout(() => row.classList.add("show"), 80 * idx);
      });

      summaryBallots.textContent = totalBallots || "‚Äì";
      summaryPerformances.textContent = results.length.toString();

      const top = results[0];
      if(top){
        summaryTopAct.textContent = top.name || "Untitled";
        summaryTopDetails.textContent =
          `Avg rank ${top.avgRank ? top.avgRank.toFixed(2) : "‚Äì"} ¬∑ ${top.ballots || 0} ballots`;
        summaryTrophy.textContent = top.name || "Audience favourite";
      } else {
        summaryTrophy.textContent = "No leader yet";
      }

      statusText.textContent = "Live results loaded";
      setUpdatedNow();
    }

    // --- Firestore finals aggregation ---

    const FIRESTORE_URL =
      "https://firestore.googleapis.com/v1/projects/lenbrook-s-got-talent/databases/(default)/documents/finalVotes";

    async function fetchAllFinalVotes() {
      const res = await fetch(FIRESTORE_URL + "?pageSize=200");
      if (!res.ok) {
        const txt = await res.text();
        throw new Error(txt || "Failed to fetch finalVotes");
      }
      const data = await res.json();
      return data.documents || [];
    }

    function aggregateVotes(docs) {
      // Map by actId (fallback to name)
      const acts = new Map();
      const totalBallots = docs.length;

      for (const doc of docs) {
        const fields = doc.fields || {};
        const actsInThisBallot = new Set();

        // assuming 5 finalists like on the finals page
        for (let i = 0; i < 5; i++) {
          const actNameField = fields["act_" + i];
          const actIdField = fields["actId_" + i];
          const rankField = fields["rank_" + i];

          if (!rankField || !actNameField) continue;

          const actName = actNameField.stringValue || "";
          const actId =
            (actIdField && actIdField.stringValue) || actName || "unknown";
          const rawRank =
            rankField.integerValue ?? rankField.stringValue ?? "";
          const rank = parseInt(rawRank, 10);
          if (!actName || !Number.isFinite(rank)) continue;

          let stats = acts.get(actId);
          if (!stats) {
            stats = {
              id: actId,
              name: actName,
              totalRank: 0,
              totalPoints: 0,
              ballots: 0
            };
            acts.set(actId, stats);
          }

          stats.totalRank += rank;

          // Convert rank to points: 1st = 5 pts, 5th = 1 pt
          stats.totalPoints += 6 - rank;

          actsInThisBallot.add(actId);
        }

        // Each act included in this ballot gets +1 ballot count
        for (const id of actsInThisBallot) {
          const stats = acts.get(id);
          if (stats) stats.ballots += 1;
        }
      }

      const results = [];
      for (const stats of acts.values()) {
        const avgRank =
          stats.ballots > 0 ? stats.totalRank / stats.ballots : null;
        results.push({
          name: stats.name,
          avgRank,
          totalPoints: stats.totalPoints,
          ballots: stats.ballots
        });
      }

      return { results, totalBallots };
    }

    async function loadFinalsResults() {
      try {
        statusText.textContent = "Loading ballots‚Ä¶";

        const docs = await fetchAllFinalVotes();
        const { results, totalBallots } = aggregateVotes(docs);

        // Render table + summary cards
        renderResults(results);

        // Override total ballots to show number of documents (ballots)
        summaryBallots.textContent = String(totalBallots);

        if (!results.length) {
          statusText.textContent = "No ballots yet";
        } else {
          statusText.textContent = "Live results loaded";
        }
      } catch (err) {
        console.error(err);
        statusText.textContent = "Error loading results";
        resultsBody.innerHTML =
          '<tr><td colspan="5" class="no-data">Failed to load results: ' +
          (err.message || err) +
          '</td></tr>';
      }
    }

    // Run once on load
    loadFinalsResults();
  </script>
</body>
</html>
