<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Lenbrook's Got Talent – Finals Voting</title>

  <style>
    :root {
      --bg0: #03040c;
      --bg1: #050716;
      --bg2: #0b1224;
      --bg3: #111827;

      --glass: rgba(8, 12, 24, 0.72);
      --glass-2: rgba(8, 12, 24, 0.52);

      --border: rgba(148, 163, 184, 0.38);
      --border-strong: rgba(148, 163, 184, 0.6);

      --text: #e5e7eb;
      --muted: #9ca3af;

      --gold: #fbbf24;
      --gold-deep: #b45309;

      --ice: #38bdf8;
      --ice-deep: #2563eb;

      --danger: #fb7185;
      --success: #4ade80;

      --radius-xl: 22px;
      --radius-lg: 16px;
      --radius-md: 12px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }

    @keyframes gradientShift {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }
    @keyframes snow-fall {
      0% { transform: translateY(-10vh) translateX(0); opacity: 0; }
      10% { opacity: 1; }
      100% { transform: translateY(110vh) translateX(25px); opacity: 0; }
    }
    @keyframes float-soft {
      0% { transform: translateY(0); }
      50% { transform: translateY(-6px); }
      100% { transform: translateY(0); }
    }

    body{
      font-family: -apple-system, BlinkMacSystemFont, "Inter", system-ui, sans-serif;
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 15% -10%, rgba(56,189,248,.22), transparent 60%),
        radial-gradient(900px 650px at 85% -12%, rgba(251,191,36,.20), transparent 58%),
        radial-gradient(1200px 900px at 50% 110%, rgba(99,102,241,.16), transparent 60%),
        linear-gradient(135deg, var(--bg0), var(--bg1), var(--bg2), var(--bg3));
      background-size: 200% 200%;
      animation: gradientShift 28s ease infinite;
      overflow-x: hidden;
      display: grid;
      place-items: center;
      padding: 22px;
      position: relative;
    }

    /* Stage lights overlay */
    .stage-lights{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 1;
      background:
        radial-gradient(900px 420px at 20% 0%, rgba(56,189,248,.18), transparent 60%),
        radial-gradient(900px 420px at 80% 0%, rgba(251,191,36,.16), transparent 60%),
        linear-gradient(to bottom, rgba(0,0,0,.35), transparent 45%, rgba(0,0,0,.55));
      mix-blend-mode: screen;
      opacity: .9;
    }

    /* Snow */
    .snow-wrap { position: fixed; inset: 0; overflow: hidden; pointer-events: none; z-index: 2; }
    .flake { position: absolute; top: -10vh; color: #fff; text-shadow: 0 0 10px rgba(255,255,255,0.9); opacity: 0.95; animation: snow-fall linear infinite; }

    .shell{
      width: min(780px, 100%);
      position: relative;
      z-index: 3;
      display: grid;
      gap: 14px;
    }

    .brand{
      display:flex;
      align-items:center;
      gap: 16px;
      padding: 12px 8px;
    }

    .logo{
      width: clamp(150px, 22vw, 220px);
      height: auto;
      display:block;
      filter: drop-shadow(0 0 18px rgba(129,140,248,0.55));
      animation: float-soft 7s ease-in-out infinite;
    }

    .brand-text{ display:flex; flex-direction:column; gap: 6px; }
    .title{
      font-size: 1.15rem;
      font-weight: 900;
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    .note{
      font-size: .92rem;
      color: var(--muted);
      line-height: 1.35;
    }
    .note strong{ color: var(--text); font-weight: 700; }

    .banner {
      margin-top: 6px;
      border-radius: 14px;
      padding: 10px 12px;
      background: rgba(8,12,24,0.86);
      border: 1px dashed rgba(148,163,184,0.6);
      color: var(--muted);
      font-size: 0.88rem;
      display: none;
    }
    .banner strong { color: var(--gold); }

    .card{
      background: var(--glass);
      border-radius: var(--radius-xl);
      border: 1px solid var(--border);
      padding: 1.25rem 1.15rem 1.35rem;
      box-shadow: 0 30px 110px rgba(0,0,0,.82);
      backdrop-filter: blur(18px) saturate(150%);
      -webkit-backdrop-filter: blur(18px) saturate(150%);
      position: relative;
      overflow: hidden;
    }

    /* subtle gradient border */
    .card:before{
      content:"";
      position:absolute;
      inset:0;
      pointer-events:none;
      border-radius: inherit;
      padding: 1px;
      background: linear-gradient(135deg, rgba(56,189,248,.55), rgba(251,191,36,.45), rgba(99,102,241,.35));
      -webkit-mask:
        linear-gradient(#000 0 0) content-box,
        linear-gradient(#000 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: .85;
    }

    /* Wrap card content so we can blur it on "closed" takeover */
    .card-inner{
      position: relative;
      z-index: 2;
      transition: filter 180ms ease, opacity 180ms ease;
    }

    /* CLOSED takeover state */
    .card.is-closed .card-inner{
      filter: blur(6px);
      opacity: 0.45;
      pointer-events: none;
      user-select: none;
    }

    .closed-overlay{
      position: absolute;
      inset: 0;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3;
      padding: 18px;
      background: radial-gradient(1200px 800px at 50% 20%, rgba(0,0,0,.25), rgba(0,0,0,.62));
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
    }
    .card.is-closed .closed-overlay{
      display: flex;
    }
    .closed-modal{
      width: min(520px, 100%);
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.42);
      background: rgba(2,6,23,0.78);
      box-shadow: 0 26px 90px rgba(0,0,0,.72);
      padding: 16px 16px 14px;
      text-align: center;
    }
    .closed-badge{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      border-radius: 999px;
      padding: 6px 12px;
      border: 1px solid rgba(251,113,133,0.45);
      background: rgba(251,113,133,0.12);
      color: #fecdd3;
      font-weight: 800;
      letter-spacing: .04em;
      text-transform: uppercase;
      font-size: .78rem;
      margin-bottom: 10px;
    }
    .closed-title{
      font-size: 1.25rem;
      font-weight: 950;
      letter-spacing: .01em;
      margin-bottom: 6px;
    }
    .closed-text{
      color: var(--muted);
      font-size: .95rem;
      line-height: 1.35;
    }
    .closed-tip{
      margin-top: 10px;
      color: rgba(229,231,235,.82);
      font-size: .86rem;
    }
    .closed-tip b{ color: var(--gold); }

    .card-header{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 10px;
      margin-bottom: 12px;
    }
    .card-header h2{
      font-size: 1.05rem;
      margin:0;
      font-weight: 800;
      letter-spacing: .02em;
    }

    .status-bar {
      border-radius: 999px;
      background: rgba(8,12,24,0.85);
      border: 1px solid var(--border-strong);
      padding: 0.32rem 0.8rem;
      font-size: 0.76rem;
      display: inline-flex;
      align-items: center;
      gap: 0.42rem;
      color: var(--muted);
      white-space: nowrap;
    }
    .status-dot{
      width: 7px; height: 7px; border-radius: 999px;
      background: radial-gradient(circle, #22c55e, #15803d);
      box-shadow: 0 0 10px rgba(34,197,94,0.85);
    }
    .status-dot.closed{
      background: radial-gradient(circle, #fb7185, #be123c);
      box-shadow: 0 0 10px rgba(251,113,133,0.85);
    }

    /* Progress */
    .progress-wrap{
      margin-top: 2px;
      display:flex;
      flex-direction: column;
      gap: 8px;
    }
    .progress-top{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      font-size: .86rem;
      color: var(--muted);
    }
    .progress-top b{ color: var(--text); font-weight: 800; }
    .progress-bar{
      height: 10px;
      border-radius: 999px;
      background: rgba(2,6,23,0.75);
      border: 1px solid rgba(148,163,184,.25);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,.35);
    }
    .progress-fill{
      height: 100%;
      width: 0%;
      border-radius: 999px;
      background: linear-gradient(90deg, rgba(56,189,248,.95), rgba(251,191,36,.95));
      transition: width 180ms ease-out;
    }

    /* List */
    .finalist-list{
      margin-top: 14px;
      display:flex;
      flex-direction: column;
      gap: 10px;
      max-height: 520px;
      overflow: auto;
      padding-right: 2px;
    }

    .finalist-row{
      border-radius: var(--radius-lg);
      background: rgba(2,6,23,0.62);
      border: 1px solid rgba(148,163,184,0.25);
      padding: 12px 12px 12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
      align-items: center;
      transition: transform 140ms ease, background 140ms ease, box-shadow 140ms ease, border-color 140ms ease;
    }
    .finalist-row:hover{
      transform: translateY(-1px);
      background: rgba(2,6,23,0.72);
      border-color: rgba(148,163,184,0.38);
      box-shadow: 0 14px 30px rgba(0,0,0,.35);
    }

    .finalist-main{ display:flex; flex-direction:column; gap: 4px; min-width: 0; }
    .finalist-name{
      font-weight: 850;
      font-size: .98rem;
      letter-spacing: .01em;
      line-height: 1.2;
    }
    .finalist-meta{
      font-size: .82rem;
      color: var(--muted);
      line-height: 1.25;
    }

    /* Rank buttons */
    .rank-pad{
      display:flex;
      align-items:center;
      gap: 8px;
    }

    .rank-btn{
      width: 38px;
      height: 38px;
      border-radius: 12px;
      border: 1px solid rgba(148,163,184,0.35);
      background: rgba(8,12,24,0.55);
      color: var(--text);
      font-weight: 900;
      font-size: .92rem;
      cursor:pointer;
      transition: transform 120ms ease, box-shadow 120ms ease, background 120ms ease, border-color 120ms ease, opacity 120ms ease;
      box-shadow: 0 8px 18px rgba(0,0,0,.28);
      user-select: none;
    }
    .rank-btn:hover{
      transform: translateY(-1px);
      border-color: rgba(148,163,184,0.55);
      background: rgba(8,12,24,0.72);
    }
    .rank-btn:active{
      transform: translateY(0px);
      box-shadow: 0 6px 14px rgba(0,0,0,.25);
    }
    .rank-btn.selected{
      background: radial-gradient(circle at 25% 15%, rgba(255,255,255,.95), rgba(251,191,36,.95) 55%, rgba(180,83,9,.95) 100%);
      color: #111827;
      border-color: transparent;
      box-shadow: 0 10px 22px rgba(251,191,36,.28);
    }
    .rank-btn.used{
      opacity: .35;
      cursor: not-allowed;
      transform: none !important;
      box-shadow: none;
    }

    .error-text{
      font-size: .9rem;
      color: var(--danger);
      margin-top: 10px;
      min-height: 1.2em;
    }

    .btn{
      width: 100%;
      margin-top: 10px;
      border: 0;
      border-radius: 999px;
      padding: 0.98rem 1.2rem;
      font-size: 1rem;
      font-weight: 950;
      cursor: pointer;
      background: radial-gradient(circle at 20% 20%, #ffffff 0%, var(--gold) 60%, #f97316 100%);
      color: #111827;
      box-shadow: 0 10px 28px rgba(251,191,36,0.30);
      transition: transform 150ms ease, box-shadow 150ms ease, filter 150ms ease, opacity 150ms ease;
    }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 18px 40px rgba(251,191,36,0.34);
      filter: brightness(1.02);
    }
    .btn:active{ transform: translateY(0); }
    .btn[disabled]{
      opacity: .55;
      cursor: default;
      box-shadow: none;
      transform: none;
      filter: none;
    }

    .status-msg{
      margin-top: 10px;
      font-size: .92rem;
      color: var(--ice);
      min-height: 1.2em;
      text-align: center;
    }
    .status-msg.error{ color: var(--danger); }

    .success-wrap{
      margin-top: 10px;
      text-align: center;
      font-size: .92rem;
      color: var(--ice);
      display: none;
    }
    .success-icon{ font-size: 1.55rem; margin-bottom: 0.2rem; }

    @media (max-width: 640px){
      .brand{ flex-direction: column; align-items: flex-start; gap: 10px; }
      .finalist-row{ grid-template-columns: 1fr; }
      .rank-pad{ justify-content: space-between; }
      .rank-btn{ width: 44px; height: 44px; border-radius: 14px; }
    }
  </style>
</head>

<body>
  <div class="stage-lights" aria-hidden="true"></div>
  <div class="snow-wrap" id="snowLayer" aria-hidden="true"></div>

  <div class="shell">
    <div class="brand">
      <img src="logo.png" alt="Lenbrook's Got Talent" class="logo" />
      <div class="brand-text">
        <div class="title">Finals Voting</div>
        <div class="note">
          <strong>Use each rank once.</strong> 1 = your top favourite, 5 = still great, but not your top pick.
        </div>

        <div class="banner" id="dupBanner">
          <strong>Vote already recorded on this device.</strong>
        </div>
      </div>
    </div>

    <section class="card" id="voteCard">
      <!-- CLOSED TAKEOVER OVERLAY -->
      <div class="closed-overlay" id="closedOverlay" aria-live="polite">
        <div class="closed-modal" role="status" aria-label="Voting closed">
          <div class="closed-badge">⛔ Voting Closed</div>
          <div class="closed-title">Thanks for voting!</div>
          <div class="closed-text">
            Audience voting is now closed.
          </div>
          <div class="closed-tip">
            Please watch the screen for <b>live results</b>.
          </div>
        </div>
      </div>

      <div class="card-inner">
        <header class="card-header">
          <div>
            <h2>Cast your ballot</h2>
          </div>
          <div class="status-bar" id="statusBar">
            <span class="status-dot" id="statusDot"></span>
            <span id="statusLabel">Checking status…</span>
          </div>
        </header>

        <div class="progress-wrap" aria-live="polite">
          <div class="progress-top">
            <span><b id="rankedCount">0</b> / <b id="totalCount">5</b> ranked</span>
            <span id="progressHint">Select ranks to enable submit</span>
          </div>
          <div class="progress-bar" role="progressbar" aria-valuemin="0" aria-valuemax="5" aria-valuenow="0">
            <div class="progress-fill" id="progressFill"></div>
          </div>
        </div>

        <form id="finalsForm" novalidate>
          <div id="finalistsContainer" class="finalist-list"></div>

          <div class="error-text" id="validationError"></div>

          <button type="submit" class="btn" id="submitBtn" disabled>
            Rank all acts to submit
          </button>

          <div id="statusMsg" class="status-msg"></div>

          <div id="successWrap" class="success-wrap">
            <div class="success-icon">✅</div>
            <div>Thank you! Your ballot has been recorded.</div>
          </div>
        </form>
      </div>
    </section>
  </div>

  <script>
    /* ❄ Snow */
    const snowLayer = document.getElementById("snowLayer");
    function spawnFlake() {
      if (!snowLayer) return;
      if (snowLayer.childElementCount > 220) return;
      const el = document.createElement("div");
      el.className = "flake";
      el.textContent = "•";
      el.style.fontSize = ((Math.random() * 0.7 + 0.55) * 12) + "px";
      el.style.left = (Math.random() * 100) + "vw";
      el.style.animationDuration = (Math.random() * 4 + 4) + "s";
      snowLayer.appendChild(el);
      setTimeout(() => el.remove(), 8000);
    }
    setInterval(spawnFlake, 75);

    // Silent admin reset: finals.html?reset=1
    const qs = new URLSearchParams(location.search);
    const isAdminResetMode = qs.get("reset") === "1";
    if (isAdminResetMode) {
      localStorage.removeItem("LGT_FINALS_VOTED");
      qs.delete("reset");
      const newUrl = location.pathname + (qs.toString() ? "?" + qs.toString() : "") + location.hash;
      history.replaceState({}, "", newUrl);
    }

    /* ✅ Your real acts */
    const FINALISTS = [
      { id: "wintersong", name: "Wintersong – Winter Night Duo", meta: "Alyza Knoetze & Josh Sutherland · Singing duet" },
      { id: "nocturne", name: "Nocturne", meta: "Anders Berg · Classical guitar" },
      { id: "sounds-of-persia", name: "Sounds of Persia", meta: "Amin Mashayekhi · Persian drum" },
      { id: "youve-got-a-friend-in-me", name: "You’ve Got a Friend in Me", meta: "Chris Wright · Guitar & singing" },
      { id: "silver-lining", name: "Silver Lining", meta: "Suzie Wu · Singing & fan dance" }
    ];

    const FIRESTORE_URL =
      "https://firestore.googleapis.com/v1/projects/lenbrook-s-got-talent/databases/(default)/documents/finalVotes";

    const CONFIG_URL =
      "https://firestore.googleapis.com/v1/projects/lenbrook-s-got-talent/databases/(default)/documents/config/finals";

    const voteCard = document.getElementById("voteCard");
    const form = document.getElementById("finalsForm");
    const container = document.getElementById("finalistsContainer");
    const statusMsg = document.getElementById("statusMsg");
    const validationError = document.getElementById("validationError");
    const successWrap = document.getElementById("successWrap");
    const submitBtn = document.getElementById("submitBtn");

    const statusDot = document.getElementById("statusDot");
    const statusLabel = document.getElementById("statusLabel");
    const dupBanner = document.getElementById("dupBanner");

    const rankedCountEl = document.getElementById("rankedCount");
    const totalCountEl = document.getElementById("totalCount");
    const progressFill = document.getElementById("progressFill");
    const progressHint = document.getElementById("progressHint");
    const progressbar = document.querySelector(".progress-bar");

    const VOTED_KEY = "LGT_FINALS_VOTED";

    // State: rank per finalist index (1..5), null if unset
    const ranks = new Array(FINALISTS.length).fill(null);

    function makeId() {
      return "ballot_" + Math.random().toString(36).slice(2) + Date.now().toString(36);
    }

    function clearErrors() {
      validationError.textContent = "";
      statusMsg.textContent = "";
      statusMsg.classList.remove("error");
    }

    function setFormEnabled(enabled) {
      document.querySelectorAll(".rank-btn").forEach(btn => {
        // keep "used" buttons disabled even when enabled
        const used = btn.classList.contains("used");
        btn.disabled = !enabled || used;
        btn.style.pointerEvents = enabled ? "" : "none";
      });
      submitBtn.disabled = !enabled || !isComplete();
    }

    function isVotingLockedByDevice() {
      return !!localStorage.getItem(VOTED_KEY);
    }

    function lockDeviceVoted() {
      localStorage.setItem(VOTED_KEY, new Date().toISOString());
    }

    async function getVotingOpen() {
      try {
        const res = await fetch(CONFIG_URL, { cache: "no-store" });
        if (!res.ok) return true; // default OPEN if config missing
        const data = await res.json();
        const fields = data.fields || {};
        const v = fields.votingOpen && fields.votingOpen.booleanValue;
        return (typeof v === "boolean") ? v : true;
      } catch {
        return true; // fail open
      }
    }

    function setStatus(open) {
      if (open) {
        statusDot.classList.remove("closed");
        statusLabel.textContent = "Live voting";
      } else {
        statusDot.classList.add("closed");
        statusLabel.textContent = "Voting closed";
      }
    }

    function isComplete() {
      return ranks.every(r => typeof r === "number");
    }

    function usedRanksSet(exceptIdx = -1) {
      const s = new Set();
      ranks.forEach((r, i) => {
        if (i === exceptIdx) return;
        if (typeof r === "number") s.add(r);
      });
      return s;
    }

    function updateProgressUI() {
      const done = ranks.filter(r => typeof r === "number").length;
      const total = ranks.length;
      rankedCountEl.textContent = String(done);
      totalCountEl.textContent = String(total);

      const pct = total ? Math.round((done / total) * 100) : 0;
      progressFill.style.width = pct + "%";
      progressbar.setAttribute("aria-valuenow", String(done));

      if (done === total) {
        progressHint.textContent = "Ready to submit";
        submitBtn.textContent = "Submit your rankings ⟶";
        submitBtn.disabled = false;
      } else {
        progressHint.textContent = "Select ranks to enable submit";
        submitBtn.textContent = "Rank all acts to submit";
        submitBtn.disabled = true;
      }
    }

    function updateButtonsUI() {
      FINALISTS.forEach((_, idx) => {
        const used = usedRanksSet(idx);
        const row = document.querySelector(`[data-row="${idx}"]`);
        if (!row) return;

        row.querySelectorAll(".rank-btn").forEach(btn => {
          const r = parseInt(btn.dataset.rank, 10);
          const selected = (ranks[idx] === r);

          btn.classList.toggle("selected", selected);

          const shouldDisable = !selected && used.has(r);
          btn.classList.toggle("used", shouldDisable);

          btn.disabled = shouldDisable;
          btn.setAttribute("aria-pressed", selected ? "true" : "false");
        });
      });

      updateProgressUI();
    }

    function renderFinalists() {
      container.innerHTML = "";
      FINALISTS.forEach((act, idx) => {
        const row = document.createElement("div");
        row.className = "finalist-row";
        row.dataset.row = String(idx);

        row.innerHTML = `
          <div class="finalist-main">
            <div class="finalist-name">${idx + 1}. ${act.name}</div>
            <div class="finalist-meta">${act.meta || ""}</div>
          </div>
          <div class="rank-pad" aria-label="Select rank for ${act.name}">
            ${[1,2,3,4,5].map(n => `
              <button type="button" class="rank-btn" data-idx="${idx}" data-rank="${n}" aria-pressed="false">${n}</button>
            `).join("")}
          </div>
        `;
        container.appendChild(row);
      });

      container.addEventListener("click", (e) => {
        const btn = e.target.closest(".rank-btn");
        if (!btn) return;
        if (btn.classList.contains("used")) return;

        const idx = parseInt(btn.dataset.idx, 10);
        const r = parseInt(btn.dataset.rank, 10);
        if (Number.isNaN(idx) || Number.isNaN(r)) return;

        // Toggle: clicking selected clears it
        ranks[idx] = (ranks[idx] === r) ? null : r;

        clearErrors();
        updateButtonsUI();
      });

      updateButtonsUI();
      updateProgressUI();
    }

    function showLockedUI() {
      dupBanner.style.display = "block";
      setFormEnabled(false);
      submitBtn.disabled = true;
    }

    function showClosedTakeover(show) {
      // CSS class controls blur + overlay visibility
      voteCard.classList.toggle("is-closed", !!show);
    }

    function applyUIState(open) {
      setStatus(open);

      // reset banners
      dupBanner.style.display = "none";

      // closed takeover
      showClosedTakeover(!open);

      if (!open) {
        setFormEnabled(false);
        submitBtn.disabled = true;
        return;
      }

      // open
      if (isVotingLockedByDevice()) {
        showLockedUI();
        return;
      }

      setFormEnabled(true);
      updateButtonsUI();
    }

    // Init
    renderFinalists();

    (async function initStatus() {
      const open = await getVotingOpen();
      applyUIState(open);
    })();

    // Live open/close (about ~8s)
    setInterval(async () => {
      const open = await getVotingOpen();
      applyUIState(open);
    }, 8000);

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      clearErrors();
      successWrap.style.display = "none";

      if (isVotingLockedByDevice()) {
        showLockedUI();
        return;
      }

      const open = await getVotingOpen();
      applyUIState(open);
      if (!open) return;

      if (!isComplete()) {
        validationError.textContent = "Please rank all performances (1–5) before submitting.";
        return;
      }

      // Ensure uniqueness (should already be enforced)
      const s = new Set(ranks);
      if (s.size !== FINALISTS.length) {
        validationError.textContent = "Each rank 1–5 must be used exactly once.";
        return;
      }

      statusMsg.textContent = "Submitting your vote…";
      submitBtn.disabled = true;

      try {
        const fields = {
          ballotId: { stringValue: makeId() },
          createdAt: { stringValue: new Date().toISOString() }
        };

        FINALISTS.forEach((act, idx) => {
          fields["act_" + idx] = { stringValue: act.name };
          fields["actId_" + idx] = { stringValue: act.id };
          fields["rank_" + idx] = { integerValue: String(ranks[idx]) };
        });

        const res = await fetch(FIRESTORE_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ fields })
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || "Firestore error");
        }

        lockDeviceVoted();

        // reset selections
        for (let i = 0; i < ranks.length; i++) ranks[i] = null;
        updateButtonsUI();

        form.reset();
        statusMsg.textContent = "";
        successWrap.style.display = "block";

        setFormEnabled(false);
      } catch (err) {
        console.error(err);
        statusMsg.textContent = "Failed to submit: " + (err.message || err);
        statusMsg.classList.add("error");
        submitBtn.disabled = false;
      }
    });
  </script>
</body>
</html>
