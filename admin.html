<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>Lenbrook's Got Talent ‚Äì Admin</title>

  <style>
    :root {
      --bg-start: #0a1633;
      --bg-end: #1b2b5a;
      --gold: #ffd86b;
      --white: #fff;
      --glass-bg: rgba(15, 26, 56, 0.6);
      --glass-border: rgba(255, 255, 255, 0.12);
      --text-dim: #c7d2ff;
      --danger: #ff6b6b;
      --success: #6bff9a;
    }

    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
    }

    body {
      margin: 0;
      min-height: 100vh;
      font-family: system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial;
      color: var(--white);
      background: radial-gradient(circle at 20% 20%, var(--bg-end) 0%, var(--bg-start) 60%);
      position: relative;
      overflow-x: hidden;
    }

    #snowCanvas {
      position: fixed;
      inset: 0;
      z-index: 0;
      pointer-events: none;
    }

    .page {
      position: relative;
      z-index: 1;
      padding: 24px clamp(16px,2vw,32px) 64px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .header-bar {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      gap: 16px 24px;
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      min-width: 180px;
    }

    .brand-block img {
      width: 140px;
      height: auto;
      object-fit: contain;
      filter: drop-shadow(0 4px 8px rgba(0,0,0,0.6));
    }

    .presented {
      color: var(--gold);
      font-size: 0.8rem;
      font-weight: 500;
      margin-top: 4px;
      text-shadow: 0 0 6px rgba(255,216,107,0.5);
      letter-spacing: 0.03em;
    }

    .title-block {
      flex: 1;
      min-width: 250px;
    }

    .page-title {
      margin: 0;
      font-size: clamp(1.4rem,1vw + 1rem,1.8rem);
      font-weight: 600;
      color: var(--gold);
      text-shadow: 0 0 8px rgba(255,216,107,0.4);
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }

    .page-sub {
      margin:4px 0 0;
      font-size:0.9rem;
      color:var(--text-dim);
      line-height:1.4;
    }

    .auth-line {
      margin-top:12px;
      font-size:0.8rem;
      color:var(--text-dim);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }

    .pill-btn {
      appearance:none;
      border:0;
      cursor:pointer;
      background-image:radial-gradient(circle at 0% 0%,#fff7d2 0%,#ffd86b 40%,#a87815 100%);
      color:#2a1a00;
      font-weight:600;
      border-radius:999px;
      box-shadow:
        0 12px 32px rgba(255,216,107,.4),
        0 0 60px rgba(255,216,107,.2);
      font-size:0.8rem;
      padding:8px 14px;
      line-height:1.2;
      transition:box-shadow .15s, transform .15s;
      white-space:nowrap;
    }
    .pill-btn:hover {
      transform:translateY(-1px) scale(1.03);
      box-shadow:
        0 16px 40px rgba(255,216,107,.55),
        0 0 70px rgba(255,216,107,.28);
    }

    /* card */
    .card {
      margin-top:24px;
      background:var(--glass-bg);
      border:1px solid var(--glass-border);
      box-shadow:
        0 20px 60px rgba(0,0,0,0.8),
        0 0 40px rgba(255,216,107,0.07);
      backdrop-filter:blur(8px);
      border-radius:16px;
      padding:24px clamp(16px,2vw,24px);
      animation:fadeInUp .6s both;
      overflow-x:auto;
    }

    .card h2{
      margin:0 0 12px;
      font-size:1rem;
      font-weight:600;
      color:var(--gold);
      text-shadow:0 0 8px rgba(255,216,107,0.4);
      letter-spacing:.03em;
      display:flex;
      align-items:center;
      gap:6px;
    }

    #adminStatus {
      font-size:0.85rem;
      font-weight:500;
      min-height:1.2em;
      margin-top:8px;
      color:var(--text-dim);
      text-shadow:0 0 8px rgba(0,0,0,.8);
    }
    .ok    { color: var(--success); text-shadow:0 0 6px rgba(107,255,154,.4); }
    .error { color: var(--danger);  text-shadow:0 0 6px rgba(255,107,107,.4); }

    table {
      width:100%;
      border-collapse:collapse;
      min-width:800px;
      color:var(--white);
    }

    th {
      font-size:.75rem;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.05em;
      background:rgba(255,216,107,0.08);
      color:var(--gold);
      border-bottom:1px solid rgba(255,216,107,0.4);
      text-align:left;
      padding:10px;
      white-space:nowrap;
    }

    td {
      border-bottom:1px solid rgba(255,255,255,0.07);
      padding:12px 10px;
      font-size:.85rem;
      vertical-align:top;
      color:var(--white);
    }

    tbody tr:hover {
      background:rgba(255,255,255,0.03);
    }

    video{
      width:160px;
      border-radius:10px;
      box-shadow:0 12px 32px rgba(0,0,0,.8),
                 0 0 24px rgba(255,216,107,.25);
      outline:1px solid rgba(255,216,107,.3);
      max-height:130px;
      object-fit:cover;
    }

    .nav-row {
      margin-top:28px;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }

    .nav-chip {
      font-size:0.8rem;
      color:var(--gold);
      background:rgba(255,216,107,0.08);
      border:1px solid rgba(255,216,107,0.4);
      box-shadow:0 8px 24px rgba(0,0,0,.8),0 0 24px rgba(255,216,107,.2);
      padding:8px 12px;
      border-radius:999px;
      text-decoration:none;
      font-weight:500;
      line-height:1.2;
      display:inline-flex;
      align-items:center;
      gap:6px;
      transition:box-shadow .15s, transform .15s, background .15s;
    }
    .nav-chip:hover {
      background:rgba(255,216,107,0.16);
      transform:translateY(-1px) scale(1.03);
      box-shadow:0 16px 32px rgba(0,0,0,.9),0 0 32px rgba(255,216,107,.4);
    }

    @keyframes fadeInUp {
      0% {opacity:0; transform:translateY(12px) scale(.98);}
      100% {opacity:1; transform:translateY(0) scale(1);}
    }
  </style>
</head>
<body>
  <canvas id="snowCanvas"></canvas>

  <main class="page">
    <header class="header-bar">
      <div class="brand-block">
        <img src="logo.png" alt="Lenbrook's Got Talent Logo">
        <div class="presented">Presented by Party Patrol ‚ùÑÔ∏è</div>
      </div>

      <div class="title-block">
        <h1 class="page-title">
          üîê Admin Dashboard
        </h1>
        <p class="page-sub">
          Restricted. Only Lenbrook event admin can view this.
        </p>

        <div class="auth-line">
          <button id="loginBtn" class="pill-btn">Sign in with Google</button>
          <button id="logoutBtn" class="pill-btn" style="display:none;">Sign out</button>
          <span id="whoami"></span>
        </div>

        <div id="adminStatus">Please sign in to view all submissions.</div>
      </div>
    </header>

    <section class="card" id="adminTableCard" style="display:none;">
      <h2>üìÇ All Submissions</h2>
      <div style="overflow-x:auto;">
        <table id="adminTable">
          <thead>
            <tr>
              <th>Team / Participant</th>
              <th>Description</th>
              <th>Video</th>
              <th>All Ratings (per Judge)</th>
              <th>Average</th>
            </tr>
          </thead>
          <tbody id="adminTbody"></tbody>
        </table>
      </div>
    </section>

    <div class="nav-row">
      <a class="nav-chip" href="index.html">‚¨Ö Submit an Act</a>
      <a class="nav-chip" href="review.html">üìù Judge Panel</a>
      <a class="nav-chip" href="leaderboard.html">üèÜ Leaderboard</a>
    </div>
  </main>

  <!-- Snow -->
  <script>
    const canvas = document.getElementById("snowCanvas");
    const ctx = canvas.getContext("2d");
    let w,h,flakes;
    function initSnow(){
      w=canvas.width=window.innerWidth;
      h=canvas.height=window.innerHeight;
      flakes=Array.from({length:140}).map(()=>({
        x:Math.random()*w,
        y:Math.random()*h,
        r:Math.random()*2+1,
        dY:Math.random()*1+0.5,
        dX:Math.random()*0.6-0.3
      }));
    }
    function drawSnow(){
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle="rgba(255,255,255,0.9)";
      ctx.shadowColor="rgba(255,255,255,0.6)";
      ctx.shadowBlur=8;
      flakes.forEach(f=>{
        ctx.beginPath();
        ctx.arc(f.x,f.y,f.r,0,Math.PI*2);
        ctx.fill();
      });
      flakes.forEach(f=>{
        f.y+=f.dY;
        f.x+=f.dX;
        if(f.y>h){f.y=-5;f.x=Math.random()*w;}
        if(f.x>w){f.x=0;}
        if(f.x<0){f.x=w;}
      });
      requestAnimationFrame(drawSnow);
    }
    window.addEventListener("resize",initSnow);
    initSnow();
    drawSnow();
  </script>

  <!-- Firebase Admin Logic -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import {
      getFirestore,
      collection,
      getDocs
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    import {
      getAuth,
      GoogleAuthProvider,
      signInWithPopup,
      signOut,
      onAuthStateChanged,
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    // SAME CONFIG
    const firebaseConfig = {
      apiKey: "AIzaSyCzXbIghLheIWJHEgCCI_oOe5finmUIe1U",
      authDomain: "lenbrook-s-got-talent.firebaseapp.com",
      projectId: "lenbrook-s-got-talent",
      storageBucket: "lenbrook-s-got-talent.firebasestorage.app",
      messagingSenderId: "327419181483",
      appId: "1:327419181483:web:c78bde1ba35d3bf037faee"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const loginBtn = document.getElementById("loginBtn");
    const logoutBtn = document.getElementById("logoutBtn");
    const whoami = document.getElementById("whoami");
    const adminStatus = document.getElementById("adminStatus");
    const adminCard = document.getElementById("adminTableCard");
    const adminTbody = document.getElementById("adminTbody");

    const ALLOWED_EMAIL = "kdesai@lenbrook.com";

    loginBtn.addEventListener("click", async () => {
      try {
        await signInWithPopup(auth, provider);
      } catch (err) {
        adminStatus.className = "error";
        adminStatus.textContent = "Login error: " + err;
      }
    });

    logoutBtn.addEventListener("click", async () => {
      await signOut(auth);
    });

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        whoami.textContent = "";
        loginBtn.style.display = "inline-block";
        logoutBtn.style.display = "none";
        adminStatus.className = "";
        adminStatus.textContent = "Please sign in to view all submissions.";
        adminCard.style.display = "none";
        return;
      }

      whoami.textContent = user.email;
      loginBtn.style.display = "none";
      logoutBtn.style.display = "inline-block";

      if (user.email === ALLOWED_EMAIL) {
        adminStatus.className = "ok";
        adminStatus.textContent = "‚úÖ Admin access granted.";
        adminCard.style.display = "block";
        loadAdminTable();
      } else {
        adminStatus.className = "error";
        adminStatus.textContent = "‚õî You are signed in, but not authorized.";
        adminCard.style.display = "none";
      }
    });

    async function loadAdminTable() {
      adminTbody.innerHTML = "";
      const snap = await getDocs(collection(db, "submissions"));

      snap.forEach(docSnap => {
        const data = docSnap.data();
        const ratings = data.ratings || {};
        const allRows = Object.entries(ratings).map(([judgeName, r]) => {
          return `${judgeName}: T${r.technical ?? "-"} / C${r.creativity ?? "-"} / E${r.entertainment ?? "-"} = ${r.total ?? "-"}`;
        }).join("<br>");

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td style="min-width:160px;font-weight:600;color:var(--gold);text-shadow:0 0 10px rgba(255,216,107,.4);">
            ${data.name || ""}
          </td>
          <td style="min-width:200px;color:var(--text-dim);">
            ${data.description || ""}
          </td>
          <td style="min-width:200px;">
            <video src="${data.videoURL}" controls></video>
          </td>
          <td style="min-width:220px;font-size:.8rem;line-height:1.4;">
            ${allRows || "<em>No ratings yet</em>"}
          </td>
          <td style="min-width:80px;font-weight:600;color:var(--white);text-shadow:0 0 10px rgba(0,0,0,.8),0 0 8px rgba(255,216,107,.4);text-align:center;">
            ${data.averageScore ? data.averageScore.toFixed(1) : "-"}
          </td>
        `;
        adminTbody.appendChild(tr);
      });
    }

  </script>
</body>
</html>
